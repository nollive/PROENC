---
title: "Brut_22224-bis"
output: html_notebook
---

```{r eval=false}

library(RColorBrewer)
library(readxl)
library(UpSetR)
library(gplots)
library(ggupset)
library(ggrepel)
library(ggplot2)
library(pheatmap)
library(GEOquery)
library(readr)
library(FactoMineR)
library(forcats)
library(heatmap3)
library(Biobase)
library(tools)
library(AnnotationDbi)
library(ade4)
library(ALL)
library(gcrma)
library(limma)
library(oligo)
library(affy)
library(genefilter)
library(RVAideMemoire)
library(enrichplot)
library(annotate)
library(Affyhgu133aExpr)
library(hgu133a.db)
library(pd.huex.1.0.st.v2)
library(pd.ht.hg.u133.plus.pm)
library(affycoretools)


library(dplyr)

# Fonction pour enregistrer les pheatmap (https://stackoverflow.com/questions/43051525/how-to-draw-pheatmap-plot-to-screen-and-also-save-to-file)
save_pheatmap_pdf <- function(x, filename, width=7, height=7) {
    stopifnot(!missing(x))
    stopifnot(!missing(filename))
    pdf(filename, width=width, height=height)
    grid::grid.newpage()
    grid::grid.draw(x$gtable)
    dev.off()
}




```


```{r}
#Data import#####
wd_a <- "/Users/olivier/Desktop/Projet/Test/"
knitr::opts_chunk$set(root.dir = wd_a)
 # Accessing Raw Data from GEO:
my_id = "GSE22224"
#filePaths = getGEOSuppFiles(my_id)
```


```{r}
### Import data ----

#Lecture du fichier Target
file_pheno_xlsx <-paste0(my_id,"_Target.xlsx")
file_pheno <- paste0(my_id,"_Target.txt")

data <- read_excel(paste0(wd_a,my_id,"/",file_pheno_xlsx))

write.table(data, file = file_pheno, sep = "\t", row.names = TRUE)


pd <- read.AnnotatedDataFrame(file = file_pheno, row.names = 1, header = TRUE, as.is = TRUE, sep = "\t", col.names = c("GSM", "Group", "Patient", "Treatment", "Group_short", "Description", "File"))

# Iterate through each column of pd
for (col in colnames(pd)) {
  # Remove double quotes from the column
  pd[[col]] <- gsub("\"", "", pd[[col]])
}

```

```{r}
#Changement de wd (besoin d'extraire le fichier RAW)
wd <- paste0(wd_a,my_id,"/",my_id,"_RAW")
df1 <- getGSEDataTables #??


knitr::opts_chunk$set(root.dir = wd)
write.table(matrix(dir()),file="a-list-files.txt", sep="\t")
```

```{r}
#Reads CEL files


# Lectures des fichiers .CEL
rawAffyData <- read.celfiles(filenames = pData(pd)$File, phenoData = pd)

# Vérification du bon import et première visualisation des données brutes
exprs(rawAffyData)[1:4,1:3]
boxplot(rawAffyData, which=c("all"))
hist(rawAffyData)
hist(rawAffyData, which=c("all"))
#pmSeq <- pmSequence(rawAffyData)
#pmSeq[1:5]
colnames(rawAffyData)


# Normalizes data ####
#Summarised per gene:
eset <- oligo::rma(rawAffyData) #Normalization entre les puces
eset #Voir la puce

#boxplot(eset)
#change directory: ####
```


```{r}
# annotate: #### Selon la puce, changer le package d'annotation
library(hgu133plus2.db)
eset <-annotateEset(eset,hgu133plus2.db)

# Vérification de la bonne annotation
geneName = "GAPDH"
which(fData(eset)$SYMBOL == geneName )
#head(fData(eset))



# filtration:
eset_medians <- rowMedians(Biobase::exprs(eset))
hist_res <- hist(eset_medians, 100, col = "cornsilk1", freq = FALSE, 
                 main = "Histogram of the median intensities", 
                 border = "antiquewhite4",
                 xlab = "Median intensities")
median(eset_medians)
man_threshold =median(eset_medians)
abline(v = median(eset_medians), col = "grey", lwd = 2)
abline(v = man_threshold, col = "coral4", lwd = 2)

length(which((rowMedians(exprs(eset)) >= man_threshold) == "TRUE"))

#Filtration selon la médiane d'expression (enleve aussi les NA)
data_filtr  <- eset[rowMedians(exprs(eset)) >= man_threshold,]
colnames(data_filtr) <- pData(data_filtr)$GSM
dim(data_filtr)
dim(eset)

#Rassemble tout dans un dataset
total <- cbind(fData(data_filtr), exprs(data_filtr))
dim(total)

#Export des données d'expression
#write.table(total, file=paste0("Données d'expression du ",gse_id), sep="\t")

# Suppression des genes mal annotés -> ne fonctionne pas pour l'instant
if (length(which(is.na(fData(data_filtr)$"Gene Symbol"))) != 0 ){
index <- which(is.na(fData(data_filtr)$"Gene Symbol"))
sansNA <- data_filtr[-index, ]
length(which(is.na(fData(sansNA)$"Gene Symbol") ==T ))
print(dim(data_filtr)-dim(sansNA))

data_filtr <- sansNA
sansNA_medians <- rowMedians(Biobase::exprs(sansNA))
hist_res <- hist(sansNA_medians, 100, col = "cornsilk1", freq = FALSE, 
                 main = "Histogram of the median intensities", 
                border = "antiquewhite4",
                 xlab = "Median intensities")
}
dim(data_filtr)


# NE FONCTIONNE PAS POUR L'INSTANT
# featureFilter(data_filtr, require.entrez=TRUE, remove.dupEntrez=TRUE)
# data_duplicates <- remove_duplicate_genes(eset = data_filtr, column_of_symbol = "SYMBOL")
# dim(data_duplicates)
#library(pd.hg.u133.plus.2.db)
#data_duplicates <- nsFilter(eset = data_filtr, require.entrez=TRUE, remove.dupEntrez=TRUE)
#dim(data_duplicates)

##Aggr?ger les r?plicats de g?nes par moyenne: ####

## Méthode R. Danger
DataSYMBOL <- aggregate(exprs(data_filtr), by= list(fData(data_filtr)$"SYMBOL"), mean)
dim(DataSYMBOL)
rownames(DataSYMBOL) <- DataSYMBOL[,1]
DataSYMBOL <- as.matrix(DataSYMBOL[-1])
dim(DataSYMBOL)
dim(data_filtr)
dim(pd)

##### END import #####
```

## Test
```{r}
# Load required libraries
library(dplyr)

expression_data <- data_filtr@assayData[["exprs"]]
probe_ids <- rownames(expression_data)
probe_to_symbol <- data_filtr@featureData@data %>%
  select(PROBEID, `SYMBOL`)

probe_to_symbol_map <- setNames(probe_to_symbol$`SYMBOL`, probe_to_symbol$PROBEID)
gene_symbols <- probe_to_symbol_map[probe_ids]
expression_data <- cbind(expression_data, `SYMBOL` = gene_symbols)
expression_data <- as.data.frame(expression_data)

expression_data$`SYMBOL` <- as.character(expression_data$`SYMBOL`)

## Suppression des genes dupliqués (plusieurs probes pour le meme gene)
duplicated_rows <- duplicated(expression_data$`SYMBOL`)
expression_data_unique <- expression_data[!duplicated_rows, ]


## Si on veut calculer la moyenne (long)
# expression_data_mean <- expression_data %>%
#   group_by(`Gene Symbol`) %>%
#   summarize(across(starts_with("GSM"), mean, na.rm = TRUE))

dim(data_filtr)
dim(expression_data_unique)
#dim(expression_data_mean)

indexDup <- rownames(expression_data_unique)
sansDup <- data_filtr[indexDup,]
data_filtr <- sansDup

```


## Analyse
```{r}
summary(exprs(data_filtr))
boxplot(exprs(data_filtr),outline=FALSE)
```

# Inspection des variables
```{r}
sampleInfo <- pData(data_filtr)
colnames(sampleInfo)
rownames(sampleInfo) <- sampleInfo$GSM
## Utilisation des infos contenues dans source_name_ch1 et characteristics_ch1.1 
sampleInfo <- dplyr::select(sampleInfo, Patient,Treatment,Group_short,Group,Description,GSM) 

## Si jamais on a besoin de renommer nos variables (plus lisible)
#sampleInfo <- dplyr::rename(sampleInfo,group = source_name_ch1, patient=characteristics_ch1)
#View(sampleInfo)
```


# Heatmap entre GSM
```{r}
#Calcul de la matrice de correlation d'expression des gènes pour chaque GSM (étude de correlation entre les samples)
corMatrix <- cor(exprs(data_filtr),use="c")

## Vérifier que les colonnes de sampleInfo et corMatrix soient identiques
rownames(sampleInfo)
colnames(corMatrix)

## Sinon, on peut forcer avec le code suivant
rownames(sampleInfo) <- colnames(corMatrix)


# Création de notre vecteur annotations pour les heatmaps
annotations = subset(sampleInfo, select = Treatment)

# Récupérer l'ordre des lignes en fonction de sampleInfo$GSM
order_rows <- order(sampleInfo$GSM)

# Réorganiser les lignes de la matrice de corrélation
corMatrix_ordered <- corMatrix[order_rows, order_rows]

# Créer la heatmap en utilisant pheatmap avec les lignes ordonnées #ne fonctionne pas pour l'instant
heatmapGSM_nofiltr <- pheatmap(corMatrix_ordered, 
         annotation_col = annotations,
         show_colnames = FALSE,
         main = paste0(my_id,' - Heatmap - GSM with outliers'))


save_pheatmap_pdf(heatmapGSM_nofiltr, paste0(my_id,'_heatmap-GSM-with-outliers.pdf'))
```

## Suppression des outliers
```{r}
#On remarque que le GSM553485 (HV), GSM553459 (CsA), GSM553458 (SRL) sont peu correlés aux restes des échantillons (probablement du à un effet batch, on décide de faire notre analse avec et sans ces samples.

# ENLEVER SRL
GSM_outliers <- c("GSM553458")
GSM_keep <- sampleInfo$GSM[!sampleInfo$GSM %in% GSM_outliers]
length(GSM_keep)
data_outliers <- data_filtr[, GSM_keep]
dim(data_outliers)
dim(data_filtr)


corMatrix_outliers_SRL <- cor(exprs(data_outliers), use = "c")
heatmapGSM_filtr_SRL <- pheatmap(corMatrix_outliers_SRL,
         annotation_col = annotations,
         main = paste0(my_id, ' - Heatmap - Without outlier (', GSM_outliers, ')'))

save_pheatmap_pdf(heatmapGSM_filtr_SRL, paste0(my_id,'_heatmap-GSM-sans-SRL.pdf'))



# Enlever HV et CsA
GSM_outliers <- c("GSM553485", "GSM553459")
GSM_keep <- sampleInfo$GSM[!sampleInfo$GSM %in% GSM_outliers]
length(GSM_keep)
data_outliers <- data_filtr[, GSM_keep]
dim(data_outliers)
dim(data_filtr)


corMatrix_outliers_CSA_HV <- cor(exprs(data_outliers), use = "c")
heatmapGSM_filtr_CSA_HV <- pheatmap(corMatrix_outliers_CSA_HV,
         annotation_col = annotations,
         main = paste0(my_id, ' - Heatmap - Without outlier (', paste(as.character(GSM_outliers), collapse = "-"), ')'))

save_pheatmap_pdf(heatmapGSM_filtr_CSA_HV, paste0(my_id,'_heatmap-GSM-sans-CSA-HV.pdf'))



#Enlever HV et SRL
GSM_outliers <- c("GSM553485", "GSM553458")
GSM_keep <- sampleInfo$GSM[!sampleInfo$GSM %in% GSM_outliers]


data_outliers <- data_filtr[, GSM_keep]
dim(data_outliers)
dim(data_filtr)


corMatrix_outliers_SRL_HV <- cor(exprs(data_outliers), use = "c")
heatmapGSM_filtr_SRL_HV <- pheatmap(corMatrix_outliers_SRL_HV,
         annotation_col = annotations,
         main = paste0(my_id, ' - Heatmap - Without outlier (', paste(as.character(GSM_outliers), collapse = "-"), ')'))

save_pheatmap_pdf(heatmapGSM_filtr_SRL_HV, paste0(my_id,'_heatmap-GSM-sans-SRL-HV.pdf'))


#Enlever les 3
GSM_outliers <- c("GSM553485", "GSM553459", "GSM553458")
GSM_keep <- sampleInfo$GSM[!sampleInfo$GSM %in% GSM_outliers]

data_outliers <- data_filtr[, GSM_keep]
dim(data_outliers)
dim(data_filtr)


corMatrix_outliers_CSA_SRL_HV <- cor(exprs(data_outliers), use = "c")
heatmapGSM_filtr_CSA_SRL_HV <- pheatmap(corMatrix_outliers_CSA_SRL_HV,
         annotation_col = annotations,
         show_colnames = FALSE,
         show_rownames = FALSE,
         main = paste0(my_id, ' - Heatmap - Without outlier (', paste(as.character(GSM_outliers), collapse = "-"), ')'))

save_pheatmap_pdf(heatmapGSM_filtr_CSA_SRL_HV, paste0(my_id,'_heatmap-GSM-sans-CSA-SRL-HV.pdf'))


## On choisi les outliers à enlever qui nous conviennent -> ICI LES 3
GSM_outliers <- c("GSM553485", "GSM553459", "GSM553458")
GSM_keep <- sampleInfo$GSM[!sampleInfo$GSM %in% GSM_outliers]
data_outliers <- data_filtr[, GSM_keep]
dim(data_outliers)
dim(data_filtr)
#Si cela nous convient:
data_filtr <- data_outliers
DataSYMBOL <- DataSYMBOL[, GSM_keep]


#Modification de sampleInfo:
sampleInfo <- sampleInfo[ GSM_keep,]


dim(sampleInfo)
```

# Export
```{r eval=false}
#full_output <- cbind(fData(data_filtr),exprs(data_filtr))
#write_csv(full_output, path="gse_full_output.csv")
```

# Définition de nos features (et modification des noms de features si besoin (selon version de puces))
```{r}
#Import de features à partir des données fData
features <- fData(data_filtr)
colnames(features)

## Pour garder que certaines features
features <- dplyr::select(features,"SYMBOL","GENENAME","ENTREZID")

#Renommer les features (pour visualisation ensuite, il faut enlever les espaces)
features <- features %>% 
  rename(GENE_SYMBOL = `SYMBOL`,
         GENE_TITLE = `GENENAME`)

#Affichage de features
#View(features)

#Export des features
full_output <- cbind(features,exprs(data_filtr))
write_csv(full_output, path="gse_full_output.csv")
```



# ACP
```{r}

## Attention à bien avoir transposé la matrice d'expression sinon PCA en fonction des individus et non de l'expression des genes

#PCA classique
pca <- prcomp(t(exprs(data_filtr)))

##Rajouter les informations des patients
cbind(sampleInfo, pca$x) %>% 
ggplot(aes(x = PC1, y=PC2, col=Treatment,label= GSM)) + 
  geom_point() + 
  geom_text_repel()
```


```{r}
#PCA en utilisant FactoMineR

#Calcul de l'ACP avec FactomineR
#pca_bis <- PCA(X = t(exprs(data_filtr)), ncp = 5 , graph= FALSE)
```


## Differential Expression

# Création de notre matrice design et constrast
```{r}
# Création des données de design 
design_data <- data.frame(
  Patient = c(1:dim(pData(data_filtr))[1]),  # Répéter chaque patient deux fois
  GSM =  rownames(pData(data_filtr)),
  Treatment = pData(data_filtr)$Treatment  # Selon le traitement
)

## Attention, vérifier que les GSM sont dans le bon ordre !
#View(design_data)


##Création de la matrice de design 
# ici on confronte CSA/HV/SRL
#design <- model.matrix(~0+ Treatment+Patient, data = design_data) 
design <- model.matrix(~0+ Treatment, data = design_data) 
# Afficher la matrice de design
print(design)
```


## Etablissement de la différential expression

# lmFit
```{r}
fit <- lmFit(DataSYMBOL, design)

#Vérifier qu'il n'y a pas de pb (sur les premiers coefficients)
head(fit$coefficients)
```


#Définition de nos contrasts pour la differencial expression

```{r}

## CsA vs HV vs SRL
contrasts <- makeContrasts(EffetCsA=   TreatmentCsA-TreatmentHV,
                           DiffTrtmt=   TreatmentCsA-TreatmentSRL, 
                           EffetSRL = TreatmentHV-TreatmentSRL,
                           levels=colnames(design))

# On applique nos constrasts 

fit2 <- contrasts.fit(fit, contrasts)
#fit2

```

# On utilise *empirical Bayes'* pour avoir les p-values de chaque gènes (première estimation?)
```{r}
fit2 <- eBayes(fit2)

# Résultats avec topTable
topTable(fit2)
comparisonCSA = "EffetCsA"
topTable(fit2, coef=comparisonCSA, adjust.method="BH")
comparisonSRL = "EffetSRL"
topTable(fit2, coef=comparisonSRL, adjust.method="BH")
comparisonDIFF = "DiffTrtmt"
topTable(fit2, coef=comparisonDIFF, adjust.method="BH")


#decideTests donne cb de genes sont differentially expressed
decideTests(fit2)
table(decideTests(fit2))
```


# Visualisation des resultat de la differencial expression

```{r}
fit2$genes <- features
summary(topTable(fit2))
```

```{r}
#full_results <- topTable(fit2, number=Inf)
full_results_CSA <- topTable(fit2, coef=comparisonCSA, adjust.method="BH", number=Inf)
full_results_SRL <- topTable(fit2, coef=comparisonSRL, adjust.method="BH", number=Inf)
full_results_DIFF <- topTable(fit2, coef=comparisonDIFF, adjust.method="BH", number=Inf)

full_results_CSA <- tibble::rownames_to_column(full_results_CSA,"ID")
full_results_SRL <- tibble::rownames_to_column(full_results_SRL,"ID")
full_results_DIFF <- tibble::rownames_to_column(full_results_DIFF,"ID")

#View(full_results_CSA)
```
# Visualisation des resultat de la differencial expression

```{r}

# AJOUT DE LA CATEGORIE UP/DOWN OU NON SIGNIFICATIF
fc_cutoff <- log2(1.5)
p_cutoff <- 0.05

## CSA - HV
full_results_CSA <- full_results_CSA %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns")) 

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey") 
full_results_CSA <- full_results_CSA %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down")) 


## SRL - HV
full_results_SRL <- full_results_SRL %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns")) 

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey") 
full_results_SRL <- full_results_SRL %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down"))


## CSA - SRL 
full_results_DIFF <- full_results_DIFF %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns")) 

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey") 
full_results_DIFF <- full_results_DIFF %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down"))
```

## CSA vs HV
```{r}
full_results_CSA %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison CSA vs HV"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-HV.pdf'))

```
## SRL vs HV
```{r}
full_results_SRL %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison SRL vs HV"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-SRL-HV.pdf'))
```

## CSA vs SRL
```{r}
full_results_DIFF %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison CSA vs SRL"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-SRL.pdf'))
```


## Affichage des 20 gènes ayant leur expression la plus modifiée
```{r}
topN <- 20 #Nombre de genes affichés sur le graphe
```


```{r}
#CSA vs HV
full_results_CSA %>% 
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) + 
  geom_point() +    
  geom_text_repel(col = "black", max.overlaps = 25)  + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, ' - Volcano plot - CSA vs HV - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-CSA-HV-Top20-plot.pdf'))

filter(full_results_CSA, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-HV_filtered_significant_results.csv"))
```


```{r}
#SRL vs HV
full_results_SRL %>% 
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) + 
  geom_point() +    
  geom_text_repel(col = "black", max.overlaps = 25)  + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, ' - Volcano plot - SRL vs HV - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-SRL-HV-Top20-plot.pdf'))

filter(full_results_SRL, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_SRL-HV_filtered_significant_results.csv"))
```


```{r}
#CSA VS SRL
full_results_DIFF %>% 
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) + 
  geom_point() +    
  geom_text_repel(col = "black", max.overlaps = 25)  + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold"))+
  labs(title=paste0(my_id, ' - Volcano plot - CSA vs SRL - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-CSA-SRL-Top20-plot.pdf'))

filter(full_results_DIFF, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-SRL_filtered_significant_results.csv"))
```



## Affichage des 20 gènes de la tolérance (Baron et al. 2015)
```{r}
my_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")
```

```{r}
#CSA vs HV
full_results_CSA %>% 
  dplyr::mutate(Significant = adj.P.Val < p_cutoff & abs(logFC) > fc_cutoff) %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) + 
  geom_point() + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey")) + 
  geom_text_repel(col = "black", max.overlaps = 50000) +
  labs(title="Volcano plot - CSA vs HV - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-HV-20-genes-TOL.pdf'))

filter(full_results_CSA, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-HV_filtered_significant_results.csv"))
```


```{r}
#SRL vs HV
full_results_SRL %>% 
  dplyr::mutate(Significant = adj.P.Val < p_cutoff & abs(logFC) > fc_cutoff) %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) + 
  geom_point() + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey")) + 
  geom_text_repel(col = "black", max.overlaps = 50000) +
  labs(title="Volcano plot - SRL vs HV - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-SRL-HV-20-genes-TOL.pdf'))

filter(full_results_SRL, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_SRL-HV_filtered_significant_results.csv"))
```


```{r}
#CSA vs SRL
full_results_DIFF %>% 
  dplyr::mutate(Significant = adj.P.Val < p_cutoff & abs(logFC) > fc_cutoff) %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>% 
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) + 
  geom_point() + 
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") + 
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold")) + 
  geom_text_repel(col = "black", max.overlaps = 50000) +
  labs(title="Volcano plot - CSA vs SRL - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-SRL-20-genes-TOL.pdf'))

filter(full_results_DIFF, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-SRL_filtered_significant_results.csv"))
```

### Autre visualisation (Heatmaps)


# Heatmap des 20 genes les plus significatifs
```{r}
## Top N genes
topN <- 20


## CSA vs HV
top_ids_of_interest_CSA <- mutate(full_results_CSA, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top 20 genes
top_gene_names_CSA <- mutate(full_results_CSA, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_CSA <- DataSYMBOL[top_ids_of_interest_CSA,] 

##Affichage de la heatmpa des topN genes
CSA_HV_heatmap_topN_genes <- pheatmap(gene_matrix_top_CSA,
     labels_row = top_gene_names_CSA,
     annotation_col= annotations,
     main = paste0(my_id, ' CSA vs HV - Heatmap - Top N genes '),
     scale="row")

save_pheatmap_pdf(CSA_HV_heatmap_topN_genes, paste0(my_id,'_CSA-HV_heatmap_topN_genes.pdf'))



## SRL vs HV
top_ids_of_interest_SRL <- mutate(full_results_SRL, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top 20 genes
top_gene_names_SRL <- mutate(full_results_SRL, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_SRL <- DataSYMBOL[top_ids_of_interest_SRL,] 

##Affichage de la heatmpa des topN genes
SRL_HV_heatmap_topN_genes <- pheatmap(gene_matrix_top_SRL,
     labels_row = top_gene_names_SRL,
     annotation_col= annotations,
     main = paste0(my_id, ' SRL vs HV - Heatmap - Top N genes '),
     scale="row")

save_pheatmap_pdf(SRL_HV_heatmap_topN_genes, paste0(my_id,'_SRL-HV_heatmap_topN_genes.pdf'))


## CSA vs SRL
top_ids_of_interest_DIFF <- mutate(full_results_DIFF, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top 20 genes
top_gene_names_DIFF <- mutate(full_results_DIFF, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_DIFF <- DataSYMBOL[top_ids_of_interest_DIFF,] 

##Affichage de la heatmap des topN genes
CSA_SRL_heatmap_topN_genes <- pheatmap(gene_matrix_top_DIFF,
     labels_row = top_gene_names_DIFF,
     annotation_col= annotations,
     main = paste0(my_id, ' CSA vs SRL - Heatmap - Top N genes '),
     scale="row") 

save_pheatmap_pdf(CSA_SRL_heatmap_topN_genes, paste0(my_id,'_CSA-SRL_heatmap_topN_genes.pdf'))
```


### Heatmap 20 genes de la tolérance (BARON)

```{r}
#20 GENES (BARON 2015)
Baron_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")



# CSA vs HV
Baron_ids_of_interest_CSA <-  filter(full_results_CSA,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_CSA <-  filter(full_results_CSA,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_CSA <- DataSYMBOL[Baron_ids_of_interest_CSA,]

#Affichage
#rownames(sampleInfo) <- colnames(Baron_gene_matrix_CSA)
CSA_HV_heatmap_20_genes <- pheatmap(Baron_gene_matrix_CSA,
         labels_row = Baron_gene_names_CSA,
         annotation_col= annotations,
         main = paste0(my_id, ' CSA vs HV - Heatmap - 20 genes of tolerance (Baron et al. 2015)'),
         scale="row")

save_pheatmap_pdf(CSA_HV_heatmap_20_genes, paste0(my_id,'_CSA-HV_heatmap_20_genes.pdf'))



# SRL vs HV
Baron_ids_of_interest_SRL <-  filter(full_results_SRL,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_SRL <-  filter(full_results_SRL,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_SRL <- DataSYMBOL[Baron_ids_of_interest_SRL,]

#Affichage
#rownames(sampleInfo) <- colnames(Baron_gene_matrix_SRL)
SRL_HV_heatmap_20_genes <- pheatmap(Baron_gene_matrix_SRL,
         labels_row = Baron_gene_names_SRL,
         annotation_col= annotations,
         main = paste0(my_id, ' SRL vs HV - Heatmap - 20 genes of tolerance (Baron et al. 2015)'),
         scale="row")

save_pheatmap_pdf(SRL_HV_heatmap_20_genes, paste0(my_id,'_SRL-HV_heatmap_20_genes.pdf'))



# CSA vs SRL
Baron_ids_of_interest_DIFF <-  filter(full_results_DIFF,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_DIFF <-  filter(full_results_DIFF,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_DIFF <- DataSYMBOL[Baron_ids_of_interest_DIFF,]

#Affichage
#rownames(sampleInfo) <- colnames(Baron_gene_matrix__DIFF)
CSA_SRL_heatmap_20_genes <- pheatmap(Baron_gene_matrix_DIFF,
         labels_row = Baron_gene_names_DIFF,
         annotation_col= annotations,
         main = paste0(my_id, ' CSA vs SRL - Heatmap - 20 genes of tolerance (Baron et al. 2015)'),
         scale="row")

save_pheatmap_pdf(CSA_SRL_heatmap_20_genes, paste0(my_id,'_CSA-SRL_heatmap_20_genes.pdf'))


```


```{r}

#6 GENES (DANGER 2017)
Danger_genes <- c("AKR1C3", "CD40","CTLA4","ID3", "MZB1", "TCL1A")
#my_genes <- c("MS4A1", "BANK1")
#my_genes <- c("CD40","ID3", "MZB1", "TCL1A") #CTLA4/AKR1C3 marche pas??



# CSA vs HV
Danger_ids_of_interest_CSA <-  filter(full_results_CSA,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_CSA <-  filter(full_results_CSA,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)

#Affichage
#rownames(sampleInfo) <- colnames(Danger_gene_matrix)
Danger_gene_matrix_CSA <- DataSYMBOL[Danger_ids_of_interest_CSA,]


heatmap_6_genes_CSA <- pheatmap(Danger_gene_matrix_CSA,
         labels_row = Danger_gene_names_CSA,
         annotation_col= annotations,
         main = paste0(my_id, ' CSA vs HV - Heatmap - 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_CSA, paste0(my_id,'_CSA-HV_heatmap_6_genes.pdf'))


# CSA vs HV
Danger_ids_of_interest_SRL <-  filter(full_results_SRL,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_SRL <-  filter(full_results_SRL,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)

#Affichage
#rownames(sampleInfo) <- colnames(Danger_gene_matrix)
Danger_gene_matrix_SRL <- DataSYMBOL[Danger_ids_of_interest_SRL,]


heatmap_6_genes_SRL <- pheatmap(Danger_gene_matrix_SRL,
         labels_row = Danger_gene_names_SRL,
         annotation_col= annotations,
         main = paste0(my_id, ' SRL vs HV - Heatmap - 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_SRL, paste0(my_id,'_SRL-HV_heatmap_6_genes.pdf'))



# CSA vs HV
Danger_ids_of_interest_DIFF <-  filter(full_results_DIFF,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_DIFF <-  filter(full_results_DIFF,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)

#Affichage
#rownames(sampleInfo) <- colnames(Danger_gene_matrix)
Danger_gene_matrix_DIFF <- DataSYMBOL[Danger_ids_of_interest_DIFF,]


heatmap_6_genes_DIFF <- pheatmap(Danger_gene_matrix_DIFF,
         labels_row = Danger_gene_names_DIFF,
         annotation_col= annotations,
         main = paste0(my_id, ' CSA vs SRL - Heatmap - 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_DIFF, paste0(my_id,'_CSA-SRL_heatmap_6_genes.pdf'))
```



## Test de D.E.A. bis

```{r}
index_CSA <- rownames(sampleInfo)[which(sampleInfo$Treatment == "CsA")]
index_SRL <- rownames(sampleInfo)[which(sampleInfo$Treatment == "SRL")]
index_HV <- rownames(sampleInfo)[which(sampleInfo$Treatment == "HV")]

data_CSA <- DataSYMBOL[,index_CSA]
data_SRL <- DataSYMBOL[,index_SRL]
data_HV <- DataSYMBOL[,index_HV]

##Création de la matrice de design
# ici on compare les 3 treatments (CsA vs HV, SRL vs HV et CSA vs SRL)
design_CSA_HV <- model.matrix(~ 0+ Treatment, data = rbind(sampleInfo[index_CSA,], sampleInfo[index_HV,]))
design_SRL_HV <- model.matrix(~0+ Treatment, data = rbind(sampleInfo[index_SRL,], sampleInfo[index_HV,]))
design_CSA_SRL <- model.matrix(~0+ Treatment, data = rbind(sampleInfo[index_CSA,],sampleInfo[index_SRL,]))

fit_CSA_HV <- lmFit(cbind(data_CSA, data_HV), design_CSA_HV)
fit_SRL_HV <- lmFit(cbind(data_SRL, data_HV), design_SRL_HV)
fit_CSA_SRL <- lmFit(cbind(data_CSA, data_SRL), design_CSA_SRL)
```

#Définition de nos contrasts pour la differencial expression

```{r}

## On compare T0 et T1 pour chacun des sous ensembles
contrasts_CSA_HV <- makeContrasts(CompCSA_HV = TreatmentCsA - TreatmentHV,
                           levels=colnames(design_CSA_HV))
contrasts_SRL_HV <- makeContrasts(CompSRL_HV = TreatmentSRL - TreatmentHV,
                           levels=colnames(design_SRL_HV))
contrasts_CSA_SRL <- makeContrasts(CompCSA_SRL = TreatmentCsA - TreatmentSRL,
                           levels=colnames(design_CSA_SRL))

# On applique nos constrasts

fit2_CSA_HV <- contrasts.fit(fit_CSA_HV, contrasts_CSA_HV)
fit2_SRL_HV <- contrasts.fit(fit_SRL_HV, contrasts_SRL_HV)
fit2_CSA_SRL <- contrasts.fit(fit_CSA_SRL, contrasts_CSA_SRL)
```

# On utilise *empirical Bayes'* pour avoir les p-values de chaque gènes (première estimation?)
```{r}
fit2_CSA_HV <- eBayes(fit2_CSA_HV)
fit2_SRL_HV <- eBayes(fit2_SRL_HV)
fit2_CSA_SRL <- eBayes(fit2_CSA_SRL)


# Résultats avec topTable
topTable(fit2_CSA_HV)
comparisonCSA_HV = "CompCSA_HV"
topTable(fit2_CSA_HV, coef=comparisonCSA_HV, adjust.method="BH")
#decideTests donne cb de genes sont differentially expressed
decideTests(fit2_CSA_HV)
table(decideTests(fit2_CSA_HV))

# Résultats avec topTable
topTable(fit2_SRL_HV)
comparisonSRL_HV = "CompSRL_HV"
topTable(fit2_SRL_HV, coef=comparisonSRL_HV, adjust.method="BH")
#decideTests donne cb de genes sont differentially expressed
decideTests(fit2_SRL_HV)
table(decideTests(fit2_SRL_HV))

# Résultats avec topTable
topTable(fit2_CSA_SRL)
comparisonCSA_SRL = "CompCSA_SRL"
topTable(fit2_CSA_SRL, coef=comparisonCSA_SRL, adjust.method="BH")
#decideTests donne cb de genes sont differentially expressed
decideTests(fit2_CSA_SRL)
table(decideTests(fit2_CSA_SRL))
```


# Visualisation des resultat de la differencial expression

```{r}
fit2_CSA_HV$genes <- features
summary(topTable(fit2_CSA_HV))

fit2_SRL_HV$genes <- features
summary(topTable(fit2_SRL_HV))

fit2_CSA_SRL$genes <- features
summary(topTable(fit2_CSA_SRL))
```

```{r}
full_results_CSA_HV <- topTable(fit2_CSA_HV, coef=comparisonCSA_HV, adjust.method="BH", number=Inf)
full_results_SRL_HV <- topTable(fit2_SRL_HV, coef=comparisonSRL_HV, adjust.method="BH", number=Inf)
full_results_CSA_SRL <- topTable(fit2_CSA_SRL, coef=comparisonCSA_SRL, adjust.method="BH", number=Inf)

full_results_CSA_HV <- tibble::rownames_to_column(full_results_CSA_HV,"ID")
full_results_SRL_HV <- tibble::rownames_to_column(full_results_SRL_HV,"ID")
full_results_CSA_SRL <- tibble::rownames_to_column(full_results_CSA_SRL,"ID")
```

# Visualisation des resultat de la differencial expression

```{r}
# AJOUT DE LA CATEGORIE UP/DOWN OU NON SIGNIFICATIF
fc_cutoff <- log2(1.5)
p_cutoff <- 0.05

## CSA VS HV
full_results_CSA_HV <- full_results_CSA_HV %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns"))

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey")
full_results_CSA_HV <- full_results_CSA_HV %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down"))


## SRL VS HV
full_results_SRL_HV <- full_results_SRL_HV %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns"))

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey")
full_results_SRL_HV <- full_results_SRL_HV %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down"))


## CSA VS SRL
full_results_CSA_SRL <- full_results_CSA_SRL %>%
  mutate(gene_type = case_when(logFC >= fc_cutoff & adj.P.Val <= 0.05 ~ "up",
                               logFC <= -fc_cutoff & adj.P.Val <= 0.05 ~ "down",
                               TRUE ~ "ns"))

cols <- c("up" = "gold", "down" = "blue", "ns" = "darkgrey")
full_results_CSA_SRL <- full_results_CSA_SRL %>%
  mutate(gene_type = fct_relevel(gene_type, "up", "down"))
```

## CSA vs HV
```{r}
full_results_CSA_HV %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison CSA vs HV"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-HV-bis.pdf'))

```

## SRL vs HV
```{r}
full_results_SRL_HV %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison SRL vs HV"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-SRL-HV-bis.pdf'))

```

## CSA vs HV
```{r}
full_results_CSA_SRL %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type)) + geom_point() +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold"))+
  labs(title=paste0(my_id, " - Volcano plot - Comparaison CSA vs SRL"))
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-SRL-bis.pdf'))

```


## Affichage des 20 gènes ayant leur expression la plus modifiée
```{r}
topN <- 20 #Nombre de genes affichés sur le graphe
```


```{r}
# CSA vs HV
full_results_CSA_HV %>%
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) +
  geom_point() +
  geom_text_repel(col = "black", max.overlaps = 25)  +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, ' - Volcano plot - CSA vs HV - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-CSA-HV-bis-plot.pdf'))

filter(full_results_CSA_HV, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-HV-bis_filtered_significant_results.csv"))
```


```{r}
# SRL vs HV
full_results_SRL_HV %>%
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) +
  geom_point() +
  geom_text_repel(col = "black", max.overlaps = 25)  +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey"))+
  labs(title=paste0(my_id, ' - Volcano plot - SRL vs HV - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-SRL-HV-bis-plot.pdf'))

filter(full_results_SRL_HV, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_SRL-HV-bis_filtered_significant_results.csv"))
```


```{r}
# CSA vs HV
full_results_CSA_SRL %>%
  dplyr::mutate(Rank = 1:n(), Label = ifelse(Rank < topN, GENE_SYMBOL,"")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col=gene_type,label=Label)) +
  geom_point() +
  geom_text_repel(col = "black", max.overlaps = 25)  +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold"))+
  labs(title=paste0(my_id, ' - Volcano plot - CSA vs SRL - Top ',topN,' genes '))
ggsave(paste0(my_id,'-Volcano-Comparaison-CSA-SRL-bis-plot.pdf'))

filter(full_results_CSA_SRL, adj.P.Val < 0.05, abs(logFC) > fc_cutoff) %>%
  write_csv(path=paste0(my_id,"_CSA-SRL-bis_filtered_significant_results.csv"))
```



## Affichage des 20 gènes de la tolérance (Baron et al. 2015)
```{r}
my_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")
```

```{r}
# CSA vs HV 20 gene Baron
full_results_CSA_HV %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey")) +
  geom_text_repel(col = "black", max.overlaps = 5000) +
  labs(title="Volcano plot - CSA vs HV - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-HV-bis-20-genes-TOL.pdf'))
```


```{r}
# SRL vs HV 20 gene Baron
full_results_SRL_HV %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("gold", "blue", "grey")) +
  geom_text_repel(col = "black", max.overlaps = 5000) +
  labs(title="Volcano plot - SRL vs HV - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-SRL-HV-bis-20-genes-TOL.pdf'))
```


```{r}
# CSA vs SRL 20 gene Baron
full_results_CSA_SRL %>%
  dplyr::mutate(Rank = rank(dplyr::desc(abs(logFC))), Label = ifelse(GENE_SYMBOL %in% my_genes, as.character(GENE_SYMBOL), "")) %>%
  ggplot(aes(x = logFC, y = -log10(adj.P.Val), col = gene_type, label = Label)) +
  geom_point() +
  geom_hline(yintercept = -log10(0.05),
             linetype = "dashed") +
  geom_vline(xintercept = c(-fc_cutoff, fc_cutoff),
             linetype = "dashed")+
  scale_color_manual(values=c("grey", "blue", "gold")) +
  geom_text_repel(col = "black", max.overlaps = 5000) +
  labs(title="Volcano plot - CSA vs SRL - 20 genes of tolerance (Baron et al. 2015)")
ggsave(paste0(my_id,'-Volcano-plot-Comparaison-CSA-SRL-bis-20-genes-TOL.pdf'))
```

### Autre visualisation (Heatmaps)


# Heatmap des 20 genes les plus significatifs
```{r}
## Top N genes
topN <- 20

top_ids_of_interest_CSA_HV <- mutate(full_results_CSA_HV, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top N genes
top_gene_names_CSA_HV <- mutate(full_results_CSA_HV, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_CSA_HV <- cbind(data_CSA, data_HV)[top_ids_of_interest_CSA_HV,]
write.csv(gene_matrix_top_CSA_HV, file=paste0(my_id,"_filtered_results_CSA_HV_topN_genes.csv"))

##Affichage de la heatmap des topN genes
heatmap_topN_genes_CSA_HV <- pheatmap(gene_matrix_top_CSA_HV,
     labels_row = top_gene_names_CSA_HV,
     scale="row",
     annotation_col = annotations,
     main = paste0(my_id, ' - Heatmap - CSA-HV - Top ',topN,' genes'))

save_pheatmap_pdf(heatmap_topN_genes_CSA_HV, paste0(my_id,'_heatmap_CSA_HV_topN_genes.pdf'))
```

# SRL - HV
```{r}
## Top N genes
topN <- 20

top_ids_of_interest_SRL_HV <- mutate(full_results_SRL_HV, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top N genes
top_gene_names_SRL_HV <- mutate(full_results_SRL_HV, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_SRL_HV <- cbind(data_SRL, data_HV)[top_ids_of_interest_SRL_HV,]
write.csv(gene_matrix_top_SRL_HV, file=paste0(my_id,"_filtered_results_SRL_HV_topN_genes.csv"))

##Affichage de la heatmap des topN genes
heatmap_topN_genes_SRL_HV <- pheatmap(gene_matrix_top_SRL_HV,
     labels_row = top_gene_names_SRL_HV,
     scale="row",
     annotation_col = annotations,
     main = paste0(my_id, ' - Heatmap - SRL-HV - Top ',topN,' genes'))

save_pheatmap_pdf(heatmap_topN_genes_SRL_HV, paste0(my_id,'_heatmap_SRL_HV_topN_genes.pdf'))
```

# CSA - SRL
```{r}
## Top N genes
topN <- 20

top_ids_of_interest_CSA_SRL <- mutate(full_results_CSA_SRL, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(ID)

#On recupère le nom des top N genes
top_gene_names_CSA_SRL <- mutate(full_results_CSA_SRL, Rank = 1:n()) %>% 
  filter(Rank < topN) %>% 
  pull(GENE_SYMBOL) 

## Recupere les expressions des genes d'interet
gene_matrix_top_CSA_SRL <- cbind(data_CSA, data_SRL)[top_ids_of_interest_CSA_SRL,]
write.csv(gene_matrix_top_CSA_SRL, file=paste0(my_id,"_filtered_results_CSA_SRL_topN_genes.csv"))

##Affichage de la heatmap des topN genes
heatmap_topN_genes_CSA_SRL <- pheatmap(gene_matrix_top_CSA_SRL,
     labels_row = top_gene_names_CSA_SRL,
     scale="row",
     annotation_col = annotations,
     main = paste0(my_id, ' - Heatmap - CSA-SRL - Top ',topN,' genes'))

save_pheatmap_pdf(heatmap_topN_genes_CSA_SRL, paste0(my_id,'_heatmap_CSA_SRL_topN_genes.pdf'))
```



### Heatmap 20 genes de la tolérance (BARON)

# CSA - HV
```{r}
#20 GENES (BARON 2015)
Baron_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")

Baron_ids_of_interest_CSA_HV <-  filter(full_results_CSA_HV,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_CSA_HV <-  filter(full_results_CSA_HV,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_CSA_HV <- cbind(data_CSA, data_HV)[Baron_ids_of_interest_CSA_HV,]
write.csv(x = Baron_gene_matrix_CSA_HV, file = paste0(my_id,"_filtered_results_CSA_HV_20_genes.csv"))

#Affichage
heatmap_20_genes_CSA_HV <- pheatmap(Baron_gene_matrix_CSA_HV,
         labels_row = Baron_gene_names_CSA_HV,
         annotation_col= annotations,
         scale="row",
         main = paste0(my_id, ' - Heatmap - CSA-HV- 20 genes of tolerance (Baron et al. 2015)'))

save_pheatmap_pdf(heatmap_20_genes_CSA_HV, paste0(my_id,'_heatmap_CSA_HV_20_genes.pdf'))
```

# SRL - HV
```{r}
#20 GENES (BARON 2015)
Baron_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")

Baron_ids_of_interest_SRL_HV <-  filter(full_results_SRL_HV,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_SRL_HV <-  filter(full_results_SRL_HV,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_SRL_HV <- cbind(data_SRL, data_HV)[Baron_ids_of_interest_SRL_HV,]
write.csv(x = Baron_gene_matrix_SRL_HV, file = paste0(my_id,"_filtered_results_SRL_HV_20_genes.csv"))

#Affichage
heatmap_20_genes_SRL_HV <- pheatmap(Baron_gene_matrix_SRL_HV,
         labels_row = Baron_gene_names_SRL_HV,
         annotation_col= annotations,
         scale="row",
         main = paste0(my_id, ' - Heatmap - SRL-HV- 20 genes of tolerance (Baron et al. 2015)'))

save_pheatmap_pdf(heatmap_20_genes_SRL_HV, paste0(my_id,'_heatmap_SRL_HV_20_genes.pdf'))
```

# CSA - SRL
```{r}
#20 GENES (BARON 2015)
Baron_genes <- c("TCL1A", "MZB1", "CD22", "BLK", "MS4A1", "CD79B", "BLNK", "FCRL2", "IRF4", "ID3", "AKR1C3", "HINT1", "ANXA2R","CD40", "FCER2", "CTLA4", "AKIRIN2", "EPS15", "PLBD1")

Baron_ids_of_interest_CSA_SRL <-  filter(full_results_CSA_SRL,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(ID)

Baron_gene_names_CSA_SRL <-  filter(full_results_CSA_SRL,GENE_SYMBOL %in% Baron_genes) %>% 
  pull(GENE_SYMBOL)

Baron_gene_matrix_CSA_SRL <- cbind(data_CSA, data_SRL)[Baron_ids_of_interest_CSA_SRL,]
write.csv(x = Baron_gene_matrix_CSA_SRL, file = paste0(my_id,"_filtered_results_CSA_SRL_20_genes.csv"))

#Affichage
heatmap_20_genes_CSA_SRL <- pheatmap(Baron_gene_matrix_CSA_SRL,
         labels_row = Baron_gene_names_CSA_SRL,
         annotation_col= annotations,
         scale="row",
         main = paste0(my_id, ' - Heatmap - CSA-SRL- 20 genes of tolerance (Baron et al. 2015)'))

save_pheatmap_pdf(heatmap_20_genes_CSA_SRL, paste0(my_id,'_heatmap_CSA_SRL_20_genes.pdf'))
```


## 6 GENES
```{r}
#6 GENES (DANGER 2017)
Danger_genes <- c("AKR1C3", "CD40","CTLA4","ID3", "MZB1", "TCL1A")
```

# CSA - HV
```{r}
Danger_ids_of_interest_CSA_HV <-  filter(full_results_CSA_HV,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_CSA_HV <-  filter(full_results_CSA_HV,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)  


#Affichage
Danger_gene_matrix_CSA_HV <- cbind(data_CSA, data_HV)[Danger_ids_of_interest_CSA_HV,]
write.csv(x = Danger_gene_matrix_CSA_HV, file=paste0(my_id,"_filtered_results_CSA_HV_6_genes.csv"))


heatmap_6_genes_CSA_HV <- pheatmap(Danger_gene_matrix_CSA_HV,
         labels_row = Danger_gene_names_CSA_HV,
         annotation_col= annotations,
         main = paste0(my_id, ' - Heatmap - CSA-HV- 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_CSA_HV, paste0(my_id,'_heatmap_CSA_HV_6_genes.pdf'))
```

# SRL - HV
```{r}
Danger_ids_of_interest_SRL_HV <-  filter(full_results_SRL_HV,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_SRL_HV <-  filter(full_results_SRL_HV,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)  


#Affichage
Danger_gene_matrix_SRL_HV <- cbind(data_SRL, data_HV)[Danger_ids_of_interest_SRL_HV,]
write.csv(x = Danger_gene_matrix_SRL_HV, file=paste0(my_id,"_filtered_results_SRL_HV_6_genes.csv"))


heatmap_6_genes_SRL_HV <- pheatmap(Danger_gene_matrix_SRL_HV,
         labels_row = Danger_gene_names_SRL_HV,
         annotation_col= annotations,
         main = paste0(my_id, ' - Heatmap - SRL-HV- 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_SRL_HV, paste0(my_id,'_heatmap_SRL_HV_6_genes.pdf'))
```

# CSA - SRL
```{r}
Danger_ids_of_interest_CSA_SRL <-  filter(full_results_CSA_SRL,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(ID)

Danger_gene_names_CSA_SRL <-  filter(full_results_CSA_SRL,GENE_SYMBOL %in% Danger_genes) %>% 
  pull(GENE_SYMBOL)  


#Affichage
Danger_gene_matrix_CSA_SRL <- cbind(data_CSA, data_SRL)[Danger_ids_of_interest_CSA_SRL,]
write.csv(x = Danger_gene_matrix_CSA_SRL, file=paste0(my_id,"_filtered_results_CSA_SRL_6_genes.csv"))


heatmap_6_genes_CSA_SRL <- pheatmap(Danger_gene_matrix_CSA_SRL,
         labels_row = Danger_gene_names_CSA_SRL,
         annotation_col= annotations,
         main = paste0(my_id, ' - Heatmap - CSA-SRL- 6 genes of tolerance (Danger et al. 2017)'),
         scale="row")

save_pheatmap_pdf(heatmap_6_genes_CSA_SRL, paste0(my_id,'_heatmap_CSA_SRL_6_genes.pdf'))
```




# Gene Ontology Term Enrichment analysis
```{r}
############# GO analysis ###########################
library("clusterProfiler")
library(org.Hs.eg.db)
library(DOSE)
# on rapelle que p_cutoff <- 0.05 
# et fc_cutoff <- log2(1.5)

DiffGenes_CSA <- full_results_CSA[ full_results_CSA$gene_type == 'up' | full_results_CSA$gene_type == 'down', ]
dim(DiffGenes_CSA)
UpGenes_CSA  <- full_results_CSA[ full_results_CSA$gene_type == 'up' , ]
dim(UpGenes_CSA)
DownGenes_CSA <- full_results_CSA[ full_results_CSA$gene_type == 'down', ]
dim(DownGenes_CSA)

DiffGenesSymb_CSA <- DiffGenes_CSA$GENE_SYMBOL
length(DiffGenesSymb_CSA)
UpGenesSymb_CSA <- UpGenes_CSA$GENE_SYMBOL
length(UpGenesSymb_CSA)
DownGenesSymb_CSA <- DownGenes_CSA$GENE_SYMBOL


## SRL - HV
DiffGenes_SRL <- full_results_SRL[ full_results_SRL$gene_type == 'up' | full_results_SRL$gene_type == 'down', ]
dim(DiffGenes_SRL)
UpGenes_SRL  <- full_results_SRL[ full_results_SRL$gene_type == 'up' , ]
dim(UpGenes_SRL)
DownGenes_SRL <- full_results_SRL[ full_results_SRL$gene_type == 'down', ]
dim(DownGenes_SRL)

DiffGenesSymb_SRL <- DiffGenes_SRL$GENE_SYMBOL
length(DiffGenesSymb_SRL)
UpGenesSymb_SRL <- UpGenes_SRL$GENE_SYMBOL
length(UpGenesSymb_SRL)
DownGenesSymb_SRL <- DownGenes_SRL$GENE_SYMBOL



## CSA - HV
DiffGenes_DIFF <- full_results_DIFF[ full_results_DIFF$gene_type == 'up' | full_results_DIFF$gene_type == 'down', ]
dim(DiffGenes_DIFF)
UpGenes_DIFF  <- full_results_DIFF[ full_results_DIFF$gene_type == 'up' , ]
dim(UpGenes_DIFF)
DownGenes_DIFF <- full_results_DIFF[ full_results_DIFF$gene_type == 'down', ]
dim(DownGenes_DIFF)

DiffGenesSymb_DIFF <- DiffGenes_DIFF$GENE_SYMBOL
length(DiffGenesSymb_DIFF)
UpGenesSymb_DIFF <- UpGenes_DIFF$GENE_SYMBOL
length(UpGenesSymb_DIFF)
DownGenesSymb_DIFF <- DownGenes_DIFF$GENE_SYMBOL



geneList <- features$GENE_SYMBOL
length(geneList)
keytypes(org.Hs.eg.db)
```



## GO POUR CSA-HV
```{r}
## UP GENES
ego_UP_CSA <- enrichGO(gene         = UpGenesSymb_CSA,
                universe = geneList,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                #qvalueCutoff  = 0.5,
                minGSSize=5)

dim(ego_UP_CSA)
head(ego_UP_CSA)
data.frame(ego_UP_CSA)


SelGO_UP_CSA <- ego_UP_CSA[which(ego_UP_CSA$p.adjust  < 0.05 & ego_UP_CSA$Count > 5),]

barplot(ego_UP_CSA)
barplot(ego_UP_CSA, showCategory= dim(SelGO_UP_CSA)[1] )
barplot(ego_UP_CSA, showCategory= 10)

write.table(data.frame(ego_UP_CSA), file =paste("c-GO-", comparisonCSA, "-CSA-HV-UP_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")

ego2_UP_CSA <- clusterProfiler::simplify(ego_UP_CSA, cutoff=0.8, by="p.adjust", select_fun=min)
barplot(ego2_UP_CSA)

jpeg(paste("CSA-HV-h-GO-UP", comparisonCSA, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
dev.off()
#plotGOgraph(ego_UP_CSA)
upsetplot(ego_UP_CSA)
#cnetplot(ego_UP_CSA, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_CSA$logFC)
cnetplot(ego_UP_CSA, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_CSA$logFC,   fixed = TRUE)


heatplot(ego_UP_CSA, showCategory = 25) #, foldChange = DiffGenes_CSA$logFC)
heatplot(ego_UP_CSA,showCategory = 25, foldChange = DiffGenes_CSA$logFC)

#emapplot(ego_UP_CSA)

cnetplot(ego_UP_CSA, foldChange=geneList)

```


```{r}
## DOWN GENES
ego_DOWN_CSA <- enrichGO(gene         = DownGenesSymb_CSA,
                universe = geneList,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                #qvalueCutoff  = 0.5,
                minGSSize=5)


head(ego_DOWN_CSA)
data.frame(ego_DOWN_CSA)


SelGO_DOWN_CSA <- ego_DOWN_CSA[which(ego_DOWN_CSA$p.adjust  < 0.05 & ego_DOWN_CSA$Count > 5),]

barplot(ego_DOWN_CSA)
barplot(ego_DOWN_CSA, showCategory= dim(SelGO_DOWN_CSA)[1] )
barplot(ego_DOWN_CSA, showCategory= 10)

write.table(data.frame(ego_DOWN_CSA), file =paste("c-GO-", comparisonCSA, "-CSA-HV-DOWN_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")

ego2_DOWN_CSA <- clusterProfiler::simplify(ego_DOWN_CSA, cutoff=0.8, by="p.adjust", select_fun=min)
barplot(ego2_DOWN_CSA)

jpeg(paste("CSA-HV-h-GO-DOWN", comparisonCSA, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
dev.off()
#plotGOgraph(ego_DOWN_CSA)
upsetplot(ego_DOWN_CSA)
#cnetplot(ego_DOWN_CSA, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_CSA$logFC)
cnetplot(ego_DOWN_CSA, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_CSA$logFC,   fixed = TRUE)


heatplot(ego_DOWN_CSA, showCategory = 25) #, foldChange = DiffGenes_CSA$logFC)
heatplot(ego_DOWN_CSA,showCategory = 25, foldChange = DiffGenes_CSA$logFC)

#emapplot(ego_DOWN_CSA)

cnetplot(ego_DOWN_CSA, foldChange=geneList)

```


```{r}
## DIFF GENES
ego_DIFF_CSA <- enrichGO(gene         = DiffGenesSymb_CSA,
                universe = geneList,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                #qvalueCutoff  = 0.5,
                minGSSize=5)


head(ego_DIFF_CSA)
data.frame(ego_DIFF_CSA)


SelGO_DIFF_CSA <- ego_DIFF_CSA[which(ego_DIFF_CSA$p.adjust  < 0.05 & ego_DIFF_CSA$Count > 5),]

barplot(ego_DIFF_CSA)
barplot(ego_DIFF_CSA, showCategory= dim(SelGO_DIFF_CSA)[1] )
barplot(ego_DIFF_CSA, showCategory= 10)

write.table(data.frame(ego_DIFF_CSA), file =paste("c-GO-", comparisonCSA, "-CSA-HV-DIFF_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")

ego2_DIFF_CSA <- clusterProfiler::simplify(ego_DIFF_CSA, cutoff=0.8, by="p.adjust", select_fun=min)
barplot(ego2_DIFF_CSA)

jpeg(paste("CSA-HV-h-GO-DIFF", comparisonCSA, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
dev.off()
#plotGOgraph(ego_DIFF_CSA)
upsetplot(ego_DIFF_CSA)
#cnetplot(ego_DIFF_CSA, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_CSA$logFC)
cnetplot(ego_DIFF_CSA, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_CSA$logFC,   fixed = TRUE)


heatplot(ego_DIFF_CSA, showCategory = 25) #, foldChange = DiffGenes_CSA$logFC)
heatplot(ego_DIFF_CSA,showCategory = 25, foldChange = DiffGenes_CSA$logFC)

#emapplot(ego_DIFF_CSA)

cnetplot(ego_DIFF_CSA, foldChange=geneList)

```




## GO POUR SRL-HV
```{r}
## UP GENES
ego_UP_SRL <- enrichGO(gene         = UpGenesSymb_SRL,
                universe = geneList,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                #qvalueCutoff  = 0.5,
                minGSSize=5)


head(ego_UP_SRL)
data.frame(ego_UP_SRL)
dim(ego_UP_SRL)
## PAS DE GO POUR UP SRL-HV
# SelGO_UP_SRL <- ego_UP_SRL[which(ego_UP_SRL$p.adjust  < 0.05 & ego_UP_SRL$Count > 5),]
# 
# barplot(ego_UP_SRL)
# barplot(ego_UP_SRL, showCategory= dim(SelGO_UP_SRL)[1] )
# barplot(ego_UP_SRL, showCategory= 10)
# 
# write.table(data.frame(ego_UP_SRL), file =paste("c-GO-", comparisonSRL, "-SRL-HV-UP_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_UP_SRL <- clusterProfiler::simplify(ego_UP_SRL, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_UP_SRL)
# 
# jpeg(paste("SRL-HV-h-GO-UP", comparisonSRL, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_UP_SRL)
# upsetplot(ego_UP_SRL)
# #cnetplot(ego_UP_SRL, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_SRL$logFC)
# cnetplot(ego_UP_SRL, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_SRL$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_UP_SRL, showCategory = 25) #, foldChange = DiffGenes_SRL$logFC)
# heatplot(ego_UP_SRL,showCategory = 25, foldChange = DiffGenes_SRL$logFC)
# 
# #emapplot(ego_UP_SRL)
# 
# cnetplot(ego_UP_SRL, foldChange=geneList)

```


```{r}
## DOWN GENES
ego_DOWN_SRL <- enrichGO(gene         = DownGenesSymb_SRL,
                universe = geneList,
                OrgDb         = org.Hs.eg.db,
                keyType       = 'SYMBOL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                #qvalueCutoff  = 0.5,
                minGSSize=5)

dim(ego_DOWN_SRL)
## PAS DE GO DOWN POUR SRL
# head(ego_DOWN_SRL)
# data.frame(ego_DOWN_SRL)
# 
# 
# SelGO_DOWN_SRL <- ego_DOWN_SRL[which(ego_DOWN_SRL$p.adjust  < 0.05 & ego_DOWN_SRL$Count > 5),]
# 
# barplot(ego_DOWN_SRL)
# barplot(ego_DOWN_SRL, showCategory= dim(SelGO_DOWN_SRL)[1] )
# barplot(ego_DOWN_SRL, showCategory= 10)
# 
# write.table(data.frame(ego_DOWN_SRL), file =paste("c-GO-", comparisonSRL, "-SRL-HV-DOWN_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_DOWN_SRL <- clusterProfiler::simplify(ego_DOWN_SRL, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_DOWN_SRL)
# 
# jpeg(paste("SRL-HV-h-GO-DOWN", comparisonSRL, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_DOWN_SRL)
# upsetplot(ego_DOWN_SRL)
# #cnetplot(ego_DOWN_SRL, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_SRL$logFC)
# cnetplot(ego_DOWN_SRL, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_SRL$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_DOWN_SRL, showCategory = 25) #, foldChange = DiffGenes_SRL$logFC)
# heatplot(ego_DOWN_SRL,showCategory = 25, foldChange = DiffGenes_SRL$logFC)
# 
# #emapplot(ego_DOWN_SRL)
# 
# cnetplot(ego_DOWN_SRL, foldChange=geneList)

```


```{r}
## DIFF GENES --> PAS DE GO ANALYSIS CAR PAS SIGNIFICATIF (cf. VOLCANO PLOTS)

# 
# ego_DIFF_SRL <- enrichGO(gene         = UpGenesSymb_SRL,
#                 universe = geneList,
#                 OrgDb         = org.Hs.eg.db,
#                 keyType       = 'SYMBOL',
#                 ont           = "BP",
#                 pAdjustMethod = "BH",
#                 pvalueCutoff  = 0.05,
#                 #qvalueCutoff  = 0.5,
#                 minGSSize=5)
# 
# 
# head(ego_DIFF_SRL)
# data.frame(ego_DIFF_SRL)
# 
# 
# SelGO_DIFF_SRL <- ego_DIFF_SRL[which(ego_DIFF_SRL$p.adjust  < 0.05 & ego_DIFF_SRL$Count > 5),]
# 
# barplot(ego_DIFF_SRL)
# barplot(ego_DIFF_SRL, showCategory= dim(SelGO_DIFF_SRL)[1] )
# barplot(ego_DIFF_SRL, showCategory= 10)
# 
# write.table(data.frame(ego_DIFF_SRL), file =paste("c-GO-", comparisonSRL, "-SRL-HV-DIFF_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_DIFF_SRL <- clusterProfiler::simplify(ego_DIFF_SRL, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_DIFF_SRL)
# 
# jpeg(paste("SRL-HV-h-GO-DIFF", comparisonSRL, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_DIFF_SRL)
# upsetplot(ego_DIFF_SRL)
# #cnetplot(ego_DIFF_SRL, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_SRL$logFC)
# cnetplot(ego_DIFF_SRL, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_SRL$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_DIFF_SRL, showCategory = 25) #, foldChange = DiffGenes_SRL$logFC)
# heatplot(ego_DIFF_SRL,showCategory = 25, foldChange = DiffGenes_SRL$logFC)
# 
# #emapplot(ego_DIFF_SRL)
# 
# cnetplot(ego_DIFF_SRL, foldChange=geneList)
# 
# ```
# 
# 
# 
# 
# ## GO POUR CSA-SRL
# ```{r}
# ## UP GENES
# ego_UP_DIFF <- enrichGO(gene         = UpGenesSymb_DIFF,
#                 universe = geneList,
#                 OrgDb         = org.Hs.eg.db,
#                 keyType       = 'SYMBOL',
#                 ont           = "BP",
#                 pAdjustMethod = "BH",
#                 pvalueCutoff  = 0.05,
#                 #qvalueCutoff  = 0.5,
#                 minGSSize=5)
# 
# 
# head(ego_UP_DIFF)
# data.frame(ego_UP_DIFF)
# 
# 
# SelGO_UP_DIFF <- ego_UP_DIFF[which(ego_UP_DIFF$p.adjust  < 0.05 & ego_UP_DIFF$Count > 5),]
# 
# barplot(ego_UP_DIFF)
# barplot(ego_UP_DIFF, showCategory= dim(SelGO_UP_DIFF)[1] )
# barplot(ego_UP_DIFF, showCategory= 10)
# 
# write.table(data.frame(ego_UP_DIFF), file =paste("c-GO-", comparisonDIFF, "-CSA-SRL-UP_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_UP_DIFF <- clusterProfiler::simplify(ego_UP_DIFF, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_UP_DIFF)
# 
# jpeg(paste("CSA-SRL-h-GO-UP", comparisonDIFF, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_UP_DIFF)
# upsetplot(ego_UP_DIFF)
# #cnetplot(ego_UP_DIFF, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_DIFF$logFC)
# cnetplot(ego_UP_DIFF, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_DIFF$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_UP_DIFF, showCategory = 25) #, foldChange = DiffGenes_DIFF$logFC)
# heatplot(ego_UP_DIFF,showCategory = 25, foldChange = DiffGenes_DIFF$logFC)
# 
# #emapplot(ego_UP_DIFF)
# 
# cnetplot(ego_UP_DIFF, foldChange=geneList)
# 
# ```
# 
# 
# ```{r}
# ## DOWN GENES
# ego_DOWN_DIFF <- enrichGO(gene         = UpGenesSymb_DIFF,
#                 universe = geneList,
#                 OrgDb         = org.Hs.eg.db,
#                 keyType       = 'SYMBOL',
#                 ont           = "BP",
#                 pAdjustMethod = "BH",
#                 pvalueCutoff  = 0.05,
#                 #qvalueCutoff  = 0.5,
#                 minGSSize=5)
# 
# 
# head(ego_DOWN_DIFF)
# data.frame(ego_DOWN_DIFF)
# 
# 
# SelGO_DOWN_DIFF <- ego_DOWN_DIFF[which(ego_DOWN_DIFF$p.adjust  < 0.05 & ego_DOWN_DIFF$Count > 5),]
# 
# barplot(ego_DOWN_DIFF)
# barplot(ego_DOWN_DIFF, showCategory= dim(SelGO_DOWN_DIFF)[1] )
# barplot(ego_DOWN_DIFF, showCategory= 10)
# 
# write.table(data.frame(ego_DOWN_DIFF), file =paste("c-GO-", comparisonDIFF, "-CSA-SRL-DOWN_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_DOWN_DIFF <- clusterProfiler::simplify(ego_DOWN_DIFF, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_DOWN_DIFF)
# 
# jpeg(paste("CSA-SRL-h-GO-DOWN", comparisonDIFF, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_DOWN_DIFF)
# upsetplot(ego_DOWN_DIFF)
# #cnetplot(ego_DOWN_DIFF, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_DIFF$logFC)
# cnetplot(ego_DOWN_DIFF, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_DIFF$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_DOWN_DIFF, showCategory = 25) #, foldChange = DiffGenes_DIFF$logFC)
# heatplot(ego_DOWN_DIFF,showCategory = 25, foldChange = DiffGenes_DIFF$logFC)
# 
# #emapplot(ego_DOWN_DIFF)
# 
# cnetplot(ego_DOWN_DIFF, foldChange=geneList)
# 
# ```
# 
# 
# ```{r}
# ## DIFF GENES
# ego_DIFF_DIFF <- enrichGO(gene         = UpGenesSymb_DIFF,
#                 universe = geneList,
#                 OrgDb         = org.Hs.eg.db,
#                 keyType       = 'SYMBOL',
#                 ont           = "BP",
#                 pAdjustMethod = "BH",
#                 pvalueCutoff  = 0.05,
#                 #qvalueCutoff  = 0.5,
#                 minGSSize=5)
# 
# 
# head(ego_DIFF_DIFF)
# data.frame(ego_DIFF_DIFF)
# 
# 
# SelGO_DIFF_DIFF <- ego_DIFF_DIFF[which(ego_DIFF_DIFF$p.adjust  < 0.05 & ego_DIFF_DIFF$Count > 5),]
# 
# barplot(ego_DIFF_DIFF)
# barplot(ego_DIFF_DIFF, showCategory= dim(SelGO_DIFF_DIFF)[1] )
# barplot(ego_DIFF_DIFF, showCategory= 10)
# 
# write.table(data.frame(ego_DIFF_DIFF), file =paste("c-GO-", comparisonDIFF, "-CSA-SRL-DIFF_diff-",".txt", sep=""), sep="\t",  na="NA", dec=".")
# 
# ego2_DIFF_DIFF <- clusterProfiler::simplify(ego_DIFF_DIFF, cutoff=0.8, by="p.adjust", select_fun=min)
# barplot(ego2_DIFF_DIFF)
# 
# jpeg(paste("CSA-SRL-h-GO-DIFF", comparisonDIFF, ".jpeg", sep=""), width=6, height=6, units="in", res=400, quality=100)
# dev.off()
# #plotGOgraph(ego_DIFF_DIFF)
# upsetplot(ego_DIFF_DIFF)
# #cnetplot(ego_DIFF_DIFF, showCategory = 3, categorySize="pvalue", foldChange= DiffGenes_DIFF$logFC)
# cnetplot(ego_DIFF_DIFF, showCategory = 5, categorySize = "geneNum", foldChange = DiffGenes_DIFF$logFC,   fixed = TRUE)
# 
# 
# heatplot(ego_DIFF_DIFF, showCategory = 25) #, foldChange = DiffGenes_DIFF$logFC)
# heatplot(ego_DIFF_DIFF,showCategory = 25, foldChange = DiffGenes_DIFF$logFC)
# 
# #emapplot(ego_DIFF_DIFF)
# 
# cnetplot(ego_DIFF_DIFF, foldChange=geneList)

```